---
description: Outline of Docflow workflow and rules to follow.
globs:
alwaysApply: true
---
# DocFlow Workflow Rules

## Context Loading Priority
1. Always load: /docflow/context/overview.md
2. Always load: /docflow/ACTIVE.md
3. **Check for status=REVIEW specs in /docflow/specs/active/ (for DocFlow agent)**
4. **Check for status=QE_TESTING specs in /docflow/specs/active/ (for user testing confirmation)**
5. For current work: Load active spec from /docflow/specs/active/
6. For technical details: Load /docflow/context/stack.md and standards.md
7. For project knowledge: Load relevant docs from /docflow/knowledge/ on-demand

## Status-Based Implementation Workflow

### Status States
Specs progress through these states:

**Full Workflow (Features & Bugs):**
- **BACKLOG**: Spec exists but not yet ready for implementation
- **READY**: DocFlow has prepared spec, ready for implementation agent
- **IMPLEMENTING**: Implementation agent is actively working
- **REVIEW**: Implementation complete, needs DocFlow code review
- **QE_TESTING**: DocFlow approved code, ready for user QE/functional testing
- **COMPLETE**: User confirmed working, ready to archive

**Simplified Workflow (Chores & Ideas):**
- **BACKLOG**: Captured but not started
- **ACTIVE**: Currently working on it
- **COMPLETE**: User approved, ready to archive

**Note:** Chores skip formal review/QE steps but still require user approval before closing.

### DocFlow Agent Responsibilities

**When Creating/Preparing Specs:**
1. Create specs with status=BACKLOG, AssignedTo=Unassigned initially
2. When activating work (via /start-session), set status=READY
3. Get developer username and set AssignedTo=@username:
   - First try: `git config github.user`
   - Fallback: `git config user.name`
   - If neither available: use "Developer"
4. If spec already assigned to someone else, warn user before proceeding
5. Ensure all acceptance criteria are clear and testable
6. Document patterns to follow in Technical Notes
7. Set owner=Implementation
8. Update /docflow/ACTIVE.md and /docflow/INDEX.md

**When Reviewing Implementations (status=REVIEW):**
1. Check for specs with status=REVIEW regularly (prioritize on session start)
2. Load the spec and read Implementation Notes section
3. Verify each acceptance criterion is met
4. Check for unauthorized scope changes
5. Verify compliance with /docflow/context/standards.md
6. Fill out DocFlow Review section
7. If code quality approved:
   - Set status=QE_TESTING
   - Set owner=User
   - Add note in Review section: "‚úÖ Code review passed. Ready for QE testing and validation."
   - **DO NOT** move to complete folder yet
   - **DO NOT** mark as COMPLETE yet
   - Notify user: "Ready for your QE testing and validation!"
8. If code issues found:
   - Add detailed notes in Review section
   - Set status=IMPLEMENTING
   - Set owner=Implementation
   - List specific changes needed

**When Checking QE_TESTING Status:**
1. Check for specs with status=QE_TESTING on every interaction
2. If user reports they're testing, provide guidance on what to verify
3. Wait for explicit user confirmation before closing
4. Never automatically move QE_TESTING ‚Üí COMPLETE

**When User Approves QE Testing (status=QE_TESTING for Features/Bugs):**
1. User says approval phrases like:
   - "approve this" / "looks good" / "works great"
   - "ready to close" / "ship it" / "all good"
   - "QE passed" / "testing passed" / "verified"
2. DocFlow agent then:
   - Fill out QE Testing section in spec
   - Set status=COMPLETE
   - Set owner=DocFlow
   - Update Decision Log with QE approval date
   - Move to /docflow/specs/complete/YYYY-QQ/ (atomic: delete then create)
   - Update /docflow/ACTIVE.md and /docflow/INDEX.md
   - Confirm: "Spec approved and archived! üéâ"

**When User Approves Chores (status=ACTIVE):**
1. For chores, agent can suggest completion but must wait for user approval
2. Agent suggests: "This chore looks complete. Ready to close?"
3. User approval phrases same as above
4. On approval:
   - Fill out User Approval section
   - Set status=COMPLETE
   - Move to /docflow/specs/complete/YYYY-QQ/
   - Update /docflow/ACTIVE.md and /docflow/INDEX.md
   - Confirm: "Chore complete and archived! üéâ"

**When User Reports QE Issues (status=QE_TESTING):**
1. User reports bugs, issues, or requested changes
2. DocFlow agent:
   - Document issues in QE Testing section
   - Add issues to Implementation Notes
   - Set status=IMPLEMENTING
   - Set owner=Implementation
   - Summarize what needs to be fixed
3. Implementation agent addresses issues and returns to REVIEW
4. Process repeats: REVIEW ‚Üí QE_TESTING ‚Üí approval

### Implementation Agent Responsibilities

**On Startup:**
1. Check /docflow/specs/active/ for any spec with status=READY or status=ACTIVE (for chores)
2. **Filter by assignment:**
   - Get current developer username (git config github.user || git config user.name || "Developer")
   - If spec.AssignedTo = Unassigned: Available to work on
   - If spec.AssignedTo = @currentUser: Available to work on
   - If spec.AssignedTo = @otherUser: Skip, show as "Assigned to @otherUser"
3. If multiple available, ask user which to work on or take highest priority
4. If none available, report: "No work available. [X] specs assigned to others: [list with names]"
5. Load spec completely into context
6. Set status=IMPLEMENTING, owner=Implementation, update Last Updated

**During Implementation:**
1. Fill Implementation Notes section progressively
2. Update acceptance criteria as completed: [ ] ‚Üí [x]
3. Document key decisions and why
4. Note any deviations from original spec with justification
5. Update Last Updated timestamp
6. If spec needs visual/reference assets, create /docflow/specs/assets/[spec-name]/

**On Completion:**
1. Verify all acceptance criteria checked off
2. Complete Implementation Notes section:
   - All files changed
   - Key implementation decisions
   - Any deviations with justification
   - Blockers encountered
3. Run validation (TypeScript, tests, manual checks)
4. Set status=REVIEW, owner=DocFlow
5. Provide brief summary to user
6. Wait for DocFlow review, then user QE testing

**On Blocker:**
1. Document blocker in Implementation Notes
2. Set status=REVIEW, owner=DocFlow (requires input)
3. Explain what's blocking and what's needed

**When Addressing QE Issues:**
1. Load spec with QE Testing section to see reported issues
2. Fix reported bugs/issues
3. Update Implementation Notes with fixes applied
4. Set status=REVIEW, owner=DocFlow
5. Brief summary of what was fixed

### Workflow State Checks

**For DocFlow Agent:**
- On every interaction, check for status=REVIEW specs (highest priority)
- Check for status=QE_TESTING specs (check for user approval)
- After code review, set status=QE_TESTING (not COMPLETE)
- Only move to COMPLETE after user confirms QE testing passed
- When activating work, set status=READY

**For Implementation Agent:**
- On startup, check for status=READY specs
- If none found, report "No work in queue"
- Set status=IMPLEMENTING when starting
- Set status=REVIEW when complete

## CRITICAL: File Movement Rules (MUST FOLLOW)

### Rule 0: NEVER Create Root-Level Status Files
**FORBIDDEN - These patterns are BANNED:**
- ‚ùå Creating status files in project root (PHASE_*_STATUS.md, STATUS.md, PROGRESS.md)
- ‚ùå Creating checklist files in project root (PHASE_*_CHECKLIST.md, CHECKLIST.md, TODO.md)
- ‚ùå Creating any tracking files outside /docflow/ directory
- ‚ùå Creating summary files in root (SUMMARY.md, NOTES.md, UPDATES.md)
- ‚ùå Creating implementation summaries in root (*_SUMMARY.md, *_IMPLEMENTATION.md, *_REFACTOR.md)

**REQUIRED - Always use DocFlow structure:**
- ‚úÖ All status updates ‚Üí /docflow/ACTIVE.md
- ‚úÖ All spec details ‚Üí /docflow/specs/[active|backlog|complete]/[spec-name].md
- ‚úÖ All decisions ‚Üí spec's Decision Log section
- ‚úÖ All checklists ‚Üí spec's Acceptance Criteria or Testing section
- ‚úÖ All notes ‚Üí spec's Notes section or Decision Log

**If you create a root-level status file, you are violating the DocFlow system.**

**‚ú® WHEN COMPLETING WORK - YOU MUST DO ONE OF THESE:**

**Option A: Small Changes/Fixes/Refactors**
‚Üí Add "Recently Completed" section to `/docflow/ACTIVE.md`

Example format:
```markdown
## ‚úÖ Recently Completed: [Name] (YYYY-MM-DD)

**What Changed**: Brief description
**Files Modified**: List of key files
**Impact**: What improved
**Decision Log**: Key decisions made

### Implementation Details
- Decision 1: Why we chose X
- Decision 2: How we handled Y
```

**Option B: Large Features/Enhancements**
‚Üí Create spec in `/docflow/specs/active/[name].md`, work on it, move to `/complete/YYYY-QQ/`

Required spec sections:
- Problem statement
- Solution approach
- Implementation details
- Decision Log (with dates)
- Testing checklist
- Success metrics

**Option C: NEVER ALLOWED**
‚Üí ‚ùå Create SUMMARY.md, STATUS.md, NOTES.md, or any .md file in project root

**Work Completion Checklist (BEFORE you say "done"):**
- [ ] Updated `/docflow/ACTIVE.md` with completion entry OR
- [ ] Created/moved spec in `/docflow/specs/complete/YYYY-QQ/` OR
- [ ] Updated existing active spec's Decision Log
- [ ] Updated `/docflow/INDEX.md` if spec was moved (same operation)
- [ ] Deleted source spec file if moved (atomic move)
- [ ] Did NOT create ANY .md files in project root

### Rule 1: Always Move Files Atomically
When moving specs between folders, ALWAYS:
1. **Delete the source file FIRST**
2. **Then create the destination file**
3. **NEVER copy without deleting** (this creates duplicates)

### Rule 2: Update INDEX.md IMMEDIATELY
Every time you move a spec file, update /docflow/INDEX.md in the SAME operation:
- Remove from old section (Active/Backlog/Completed)
- Add to new section with status and date
- Update priority order if needed

### Rule 3: Update ACTIVE.md IMMEDIATELY
Every time you move a spec file, update /docflow/ACTIVE.md in the SAME operation:
- Remove completed items from Primary Focus/Secondary
- Add new active items to Primary Focus/Secondary
- Update Last Updated timestamp

### Rule 4: Automatic File Movement Triggers
Move specs automatically when these conditions are met:

**Backlog ‚Üí Active:**
- When user says "start working on [spec]" or "activate [spec]"
- When spec is referenced as current focus
- When `/start-session` moves item to active

**Active ‚Üí Complete:**
- **ONLY when user explicitly approves QE testing**
- When user says "approve", "looks good", "ship it", "QE passed", etc.
- When spec status=QE_TESTING and user confirms
- When `/wrap-session` completes an item AND user confirms

**Complete Archiving:**
- Move to /complete/YYYY-QQ/ at end of each quarter
- Or immediately if explicitly requested

### Rule 5: Prevent Duplicates
- Before creating any spec file, check if it exists in ANY folder
- If found, update existing file instead of creating new one
- If moving, delete source before creating destination

### Rule 6: Incremental Updates
Update /docflow/INDEX.md and /docflow/ACTIVE.md immediately when:
- Adding new specs to backlog
- Moving specs between folders
- Completing acceptance criteria
- Starting/stopping work on items

## Workflow Commands
The following commands are available in `.cursor/commands/`:
- `/new-project` - Set up new project through conversational flow
- `/scan-project` - Analyze existing codebase and retrofit DocFlow
- `/start-session` - Begin work session, check status, start new work
- `/wrap-session` - Save progress and checkpoint current work
- `/capture` - Quickly capture new ideas/features/bugs to backlog
- `/review` - Review and refine backlog items for active work

Type `/` in chat to see and use these commands.

## Conversational Command Triggers

### Start Session Triggers
When user says any of these, run `/start-session`:
- "let's start" / "let's get started" / "let's begin"
- "start a session" / "start my session" / "start work"
- "what should I work on" / "what's next"
- "begin work" / "begin my day"
- "let's code" / "ready to code"
- "what am I working on"
- "resume work" / "continue working"
- Opening a new conversation (suggest: "Would you like to /start-session?")

### Wrap Session Triggers
When user says any of these, run `/wrap-session`:
- "let's wrap" / "wrap it up" / "wrap up"
- "I'm done" / "done for now" / "done for the day"
- "stopping" / "taking a break" / "heading out"
- "save progress" / "checkpoint"
- "end session" / "close session"
- "let's stop" / "time to stop"
- "call it a day" / "that's it for now"
- "pause work" / "pause here"

### QE Approval Triggers
When user says any of these for status=QE_TESTING spec, mark as COMPLETE:
- "approve this" / "approve it" / "approved"
- "looks good" / "looks great" / "works great"
- "ready to close" / "ready to ship" / "ship it"
- "QE passed" / "testing passed" / "tests passed"
- "verified" / "confirmed" / "all good"
- "close this" / "mark complete" / "done with this"

### Capture Triggers
When user says any of these, run `/capture`:
- "capture that" / "let's capture" / "we should capture"
- "add to backlog" / "save that idea"
- "I have an idea" / "new idea"
- "found a bug" / "there's a bug"
- "we should add" / "let's add a feature"
- "make a note" / "note this"
- "remember to" / "don't forget"
- "TODO" / "FIXME" (in conversation)
- When user describes something that sounds like a feature/bug/idea, ask: "Should I /capture this?"

### Review Triggers
When user says any of these, run `/review`:
- "review [item]" / "let's review"
- "refine [item]" / "prepare [item]"
- "is [item] ready" / "check [item]"
- "look at backlog" / "check backlog"
- "what needs work" / "what needs refinement"
- "get [item] ready" / "prep [item]"
- "audit backlog" / "clean up backlog"

### New Project Triggers
When user says any of these, run `/new-project`:
- "let's start a new project" / "initialize project" / "set up a new project"
- "new project setup" / "create new project"
- Opening a project with only `/docflow/` and `.cursor/` directories
- Context files contain template placeholders like `[Project Name]`

### Scan Project Triggers
When user says any of these, run `/scan-project`:
- "scan the project" / "scan this project"
- "analyze this codebase" / "analyze the code"
- "what does this project do?" / "help me understand this code"
- "add DocFlow to this project" / "retrofit DocFlow"
- "migrate to DocFlow" / "I inherited this codebase"
- Finding existing code but DocFlow is missing or incomplete

## Automatic Command Suggestions

### Contextual Suggestions
- **Empty project with only DocFlow template** ‚Üí "Looks like a new project! Shall we /new-project to set it up?"
- **Existing code but no context files** ‚Üí "I see existing code. Should I /scan-project to understand what you have?"
- **Template placeholders in context files** ‚Üí "Context files need customization. Run /new-project or /scan-project?"
- **Empty /docflow/ACTIVE.md + Items in backlog** ‚Üí "I see you have items in backlog. Shall we /review one?"
- **Completed all acceptance criteria** ‚Üí "Looks like you've finished! Ready to /wrap-session?"
- **Spec in QE_TESTING status** ‚Üí "This feature is ready for your testing! Please verify and let me know if it looks good."
- **Switching context** ‚Üí "Before we switch, should we /wrap-session on current work?"
- **Vague feature description** ‚Üí "Interesting idea! Should I /capture this for later?"
- **Multiple specs in active** ‚Üí "You have multiple active items. Let's /start-session to focus on one?"

### Natural Language Recognition
When detecting these patterns in conversation:
- **"That would be cool if..."** ‚Üí Suggest /capture as idea
- **"It's broken when..."** ‚Üí Suggest /capture as bug
- **"We need to..."** ‚Üí Suggest /capture as feature
- **"The problem is..."** ‚Üí Could be bug or feature, ask which to /capture
- **"What if we..."** ‚Üí Suggest /capture as idea

## Before Creating ANY New Code

### Check Existing Code
1. Use `codebase_search` to find existing functionality (e.g., "How do we handle authentication?")
2. Use `grep` to search for similar patterns or components
3. Check existing modules and utilities in the codebase
4. Avoid creating duplicate functionality

### Document Discoveries
If you discover complex patterns or shared systems while searching:
- Document in /docflow/knowledge/features/ for future reference
- Add notes about gotchas in /docflow/knowledge/notes/

## When Working on Specs

### Starting New Work
1. Spec must exist in /docflow/specs/active/
2. Update /docflow/ACTIVE.md with current focus
3. Review dependencies in the spec
4. Create feature branch matching spec name

### During Implementation
1. Update spec's Decision Log with key decisions and pivots
2. Update Dependencies if new connections found
3. Keep Acceptance Criteria current
4. If blocked, note in spec and /docflow/ACTIVE.md

### Completing Work
1. Verify all Acceptance Criteria met
2. Get DocFlow code review (status=REVIEW ‚Üí QE_TESTING)
3. User performs QE testing and approves
4. Update /docflow/INDEX.md with completion date
5. Add final Decision Log entry with outcomes
6. **DELETE original file from /docflow/specs/active/**
7. **CREATE new file in /docflow/specs/complete/[YYYY-QQ]/**
8. Update /docflow/ACTIVE.md to remove completed item
9. Clean up or archive spec assets from /docflow/specs/assets/[spec-name]/ if present

## Code Principles
- TypeScript strict mode always
- Follow existing patterns defined in /docflow/context/stack.md
- No duplicate functions - search codebase first
- No duplicate components - search codebase first
- Follow standards.md for all code conventions
- Document complex patterns in /docflow/knowledge/ for reuse

## Decision Documentation
When making technical decisions:

### In Specs (Spec Decision Log)
Document implementation-specific decisions:
- How this feature was built
- Deviations from original plan
- Technical approaches chosen

### In Knowledge Base (/docflow/knowledge/decisions/)
Document architectural decisions that affect the entire project:
- Architecture choices (why X over Y)
- Breaking changes or major refactors
- Technology selection rationale
- Security or performance strategies

**Format:** NNN-decision-title.md (numbered ADRs)

## Natural Capture During Work
If user mentions something that could be a bug, feature, or idea during active work:
1. Recognize it based on context clues
2. Ask: "That sounds like a [type]. Should I /capture this?"
3. If yes, run capture command with quick capture format
4. Continue with current work without context switching

## Status Awareness
Always be aware of:
- What's currently active (/docflow/ACTIVE.md)
- What's in QE testing (check for QE_TESTING status)
- What's in the backlog (/docflow/INDEX.md)
- What's blocking progress (check specs)
- What decisions need to be made (check Decision Logs)

## Response Patterns
Before creating code, always state:
"Let me search for existing [functionality]..."

When finding existing code:
"Found existing [module/function] that handles this"

When discovering important patterns:
"This is complex/reusable. I'll document this in /docflow/knowledge/features/"

When feature ready for QE testing:
"‚úÖ Code review passed! This is ready for your QE testing. Please verify the functionality and let me know if it looks good."

When user approves QE testing:
"Perfect! Marking as complete and archiving. üéâ"

When user reports issues during QE testing:
"I'll document these issues and send back to implementation for fixes."

## Command Execution Patterns
When recognizing a trigger phrase:
1. Acknowledge the intent: "Let me help you [start/wrap/capture/review]..."
2. Execute the appropriate command
3. Follow the command's checklist completely
4. Confirm completion

Never say "you should run /command" - instead, recognize the intent and run it directly.

## Maintain Consistency
- Always follow patterns in stack.md
- Always follow conventions in standards.md
- Always update decision logs with reasoning
- Always keep /docflow/ACTIVE.md current
- Always keep /docflow/INDEX.md current
- Always move files atomically (delete source, create destination)
- Never auto-close specs in QE_TESTING without user approval
- Recognize natural language and execute commands accordingly
- Document architectural decisions in /docflow/knowledge/decisions/
- Search for existing code before creating new functionality
